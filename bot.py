import os
import random
import time
import threading
import re
import telebot

# =========================
# СЕКРЕТЫ И НАСТРОЙКИ
# =========================
TOKEN = os.getenv("TOKEN", "YOUR_TELEGRAM_BOT_TOKEN")
CHANNEL_ID = os.getenv("CHANNEL_ID", "@zalesskayarepublic")

if not TOKEN or not CHANNEL_ID or "YOUR_TELEGRAM_BOT_TOKEN" in TOKEN:
    raise RuntimeError("Укажи переменные окружения TOKEN и CHANNEL_ID!")

# parse_mode=None специально, чтобы эмодзи и шум не ломали Markdown
bot = telebot.TeleBot(TOKEN, parse_mode=None)

# =========================
# ЛОКАЦИИ
# =========================
# Залесская Республика (ЦЕЛИ): Орловская, Курская, Брянская — расширенные списки
zr_regions = {
    "Орловская": [
        "Орёл","Ливны","Мценск","Болхов","Кромы","Хотынец","Новосиль","Покровское","Дмитровск",
        "Колпна","Тросна","Нарышкино","Залегощь","Верховье","Малоархангельск","Глазуновка","Шаблыкино",
        "Сосково","Урицкое","Долгое","Плещеево","Становой Колодезь","Хомутово","Красная Заря",
        "Нарышкинский округ","Кромской район","Покровский район","Знаменское","Сосковский район",
        "Мценский район","Ливенский район"
    ],
    "Курская": [
        "Курск","Льгов","Рыльск","Обоянь","Железногорск","Фатеж","Касторное","Глушково","Коренево",
        "Курчатов","Мантурово","Медвенка","Суджа","Золотухино","Щигры","Поныри","Хомутовка","Солнцево",
        "Пристень","Большое Солдатское","Тим","Горшечное","Советский","Беловский","Конышевка",
        "Черемисиново","Ольговка","Марьино","Кочка","Свобода","Беседино"
    ],
    "Брянская": [
        "Брянск","Севск","Клинцы","Стародуб","Унеча","Дятьково","Жуковка","Новозыбков","Трубчевск",
        "Суземка","Почеп","Навля","Комаричи","Карачев","Сельцо","Фокино","Клетня","Мглин",
        "Погар","Злынка","Красная Гора","Сураж","Гордеевка","Выгоничи","Дубровка",
        "Рогнедино","Брасово","Жирятино","Локоть","Белая Берёзка","Старое Село","Климово"
    ]
}

# Противник (ИСТОЧНИК/НАПРАВЛЕНИЕ ПУСКОВ): БЕЗ Орловской, Курской, Брянской!
enemy_regions = {
    "Белгородская": ["Белгород","Шебекино","Валуйки","Губкин","Старый Оскол","Грайворон","Алексеевка","Ракитное","Прохоровка","Новый Оскол"],
    "Смоленская":   ["Смоленск","Ярцево","Рославль","Сафоново","Десногорск","Дорогобуж","Вязьма","Рудня"],
    "Калужская":    ["Калуга","Обнинск","Малоярославец","Балабаново","Таруса","Козельск","Людиново","Мосальск"],
    "Тульская":     ["Тула","Новомосковск","Ефремов","Узловая","Суворов","Щёкино","Донской","Богородицк"],
    "Липецкая":     ["Липецк","Елец","Грязи","Данков","Задонск","Чаплыгин","Усмань"],
    "Воронежская":  ["Воронеж","Семилуки","Острогожск","Лиски","Россошь","Калач","Бутурлиновка","Павловск"],
    "Тамбовская":   ["Тамбов","Мичуринск","Котовск","Моршанск","Рассказово","Уварово","Жердевка"],
    "Московская":   ["Москва","Подмосковье","Химки","Мытищи","Балашиха","Одинцово","Щёлково","Коломна","Орехово-Зуево","Клин","Сергиев Посад","Домодедово","Жуковский"],
    "Рязанская":    ["Рязань","Касимов","Скопин","Сасово","Ряжск","Кораблино"],
    "Тверская":     ["Тверь","Ржев","Вышний Волочёк","Торжок","Кимры","Бежецк"],
    "Ярославская":  ["Ярославль","Рыбинск","Переславль-Залесский","Углич","Тутаев"],
    "Прочие":       ["граница РФ (Белгород)","Смоленское направление","Рязанское направление","Калужское направление","Подмосковное направление"]
}

# Плоские списки
our_locations = [c for cities in zr_regions.values() for c in cities]
enemy_locations = [c for cities in enemy_regions.values() for c in cities]

# =========================
# СЦЕНАРИИ
# =========================
patterns = [
    "‼️ {loc1} — удары с территории {enemy}",
    "⚡ прилёты по {loc1}, источник огня — {enemy}",
    "‼️ пролёт ракет над {loc1}, курс на {loc2}",
    "⚡ мощный взрыв в районе {loc1}, направление удара — {enemy}",
    "‼️ артобстрел по {loc1} с позиций {enemy}",
    "⚡ ракета стартовала из {enemy}, цель — {loc2}",
    "‼️ БПЛА замечен у {loc1}, курс с {enemy}",
    "⚡ массовый залп из {enemy} по {loc1}",
    "‼️ прорыв ПВО, удар по {loc1}, направление {enemy}",
    "⚡ серия взрывов у {loc1}, прилёты со стороны {enemy}",
    "‼️ над {loc1} дымовой след, возможен новый залп из {enemy}",
    "⚡ над {loc1} зафиксирован рой БПЛА, трасса: {enemy} → {loc2}",
    "‼️ ПВО сработала у {loc1}, предполагаемый пуск — {enemy}",
    "⚡ отрабатывают РСЗО по {loc1}, сектор {enemy}",
    "‼️ ракета изменила курс над {loc1}, уходит в сторону {loc2}",
    "⚡ вторичная детонация в районе {loc1}, источник — {enemy}",
    "‼️ падение обломков у {loc1}, направление захода — {enemy}",
    "⚡ громкий хлопок в {loc1}, предварительно — пролёт со стороны {enemy}",
    "‼️ двойной пуск из {enemy}, вероятные цели: {loc1}, {loc2}",
    "⚡ серия ложных целей над {loc1}, пуск с {enemy}",
    "‼️ отключения света в {loc1} после удара из {enemy}",
    "⚡ след из трассеров в {loc1}, сектор {enemy}",
    "‼️ срыв перехвата над {loc1}, прилёт со стороны {enemy}",
    "⚡ спутниковая отметка: старт из {enemy}, заход на {loc2}",
    "‼️ низкая высота, проход над {loc1}; направление {enemy}",
    "⚡ точки пуска возле {enemy}, передача по {loc2}",
    "‼️ серия мини‑пролётов над {loc1}, курс на {loc2}",
    "⚡ волна БПЛА с {enemy} — удар по {loc1}",
    "‼️ предупреждение: возможны повторные пуски из {enemy}",
    "⚡ кассетный след у {loc1}, приход с {enemy}",
    "‼️ акустический след над {loc1}, старт из {enemy}",
    "⚡ дым в небе {loc1}, вероятно — ложный, сектор {enemy}",
    "‼️ мощный залп: {enemy} → {loc1}",
    "⚡ точечные прилёты: {loc1}, {loc2}; направление — {enemy}",
    "‼️ баражирующий БПЛА над {loc1}, старт с {enemy}",
    "⚡ перехват над {loc1}, остатки падают в сторону {loc2}",
    "‼️ тройной пуск из {enemy}, карта цели показывает {loc1}",
    "⚡ неизвестный объект над {loc1}, вектор — {enemy}",
    "‼️ сигналы РЭБ в районе {loc1}, предполагаем {enemy}"
]

# =========================
# РЕЖИМЫ СКОРОСТИ
# =========================
modes = {
    "затишье": (900, 1500),
    "разведка": (300, 600),
    "обстрел": (90, 180),
    "массированный удар": (20, 60),
    "хаос": (3, 20),
    "спад": (600, 1200)
}
current_mode = "обстрел"

# =========================
# УТИЛИТЫ
# =========================
def noisy_text(text: str) -> str:
    # хаос: регистр, вставки, замены, обрубание
    if random.random() < 0.3:
        text = text.lower()
    if random.random() < 0.18 and len(text) > 3:
        pos = random.randint(1, len(text)-2)
        text = text[:pos] + random.choice("абвгдежзийклмнопрстуфхцчшщ..!!") + text[pos:]
    if random.random() < 0.12:
        text = text.replace("‼️","!!").replace("⚡","*срочно*")
    if random.random() < 0.06 and len(text) > 6:
        text = text[:-random.randint(1,5)]
    # «мусор»
    if random.random() < 0.25:
        text += "\n\n📡 Радар Залесской Республики"
    if random.random() < 0.1:
        text += " #срочно"
    if random.random() < 0.05:
        text = "⚠️ " + text
    return text

def pick_two_different(seq):
    a = random.choice(seq)
    b = random.choice(seq)
    tries = 0
    while b == a and tries < 5:
        b = random.choice(seq)
        tries += 1
    return a, b

def generate_message() -> str:
    pattern = random.choice(patterns)
    # цели — ТОЛЬКО ЗР:
    loc1, loc2 = pick_two_different(our_locations)
    # источник — ТОЛЬКО враг:
    enemy = random.choice(enemy_locations)
    text = pattern.format(loc1=loc1, loc2=loc2, enemy=enemy)
    return noisy_text(text)

def switch_mode():
    global current_mode
    if random.random() < 0.2:
        current_mode = random.choice(list(modes.keys()))
        print(f"[MODE] → {current_mode}")

def safe_send(text: str):
    # анти FLOOD_WAIT / сетевые сбои
    delay = 1
    while True:
        try:
            bot.send_message(CHANNEL_ID, text)
            print("[SENT]", text)
            return
        except Exception as e:
            s = str(e)
            print("[ERROR]", s)
            m = re.search(r"Too Many Requests: retry after (\d+)", s)
            if m:
                wait = int(m.group(1)) + random.randint(1, 3)
            else:
                wait = delay
                delay = min(delay * 2, 60)
            time.sleep(wait)

def burst_count():
    # редкие серии из 2–4 постов
    return random.randint(2, 4) if random.random() < 0.15 else 1

def sender():
    global current_mode
    while True:
        n = burst_count()
        for i in range(n):
            msg = generate_message()
            safe_send(msg)
            if i < n - 1:
                time.sleep(random.randint(3, 10))  # пауза внутри серии
        low, high = modes[current_mode]
        time.sleep(random.randint(low, high))
        switch_mode()

# =========================
# ЗАПУСК
# =========================
if __name__ == "__main__":
    threading.Thread(target=sender, daemon=True).start()
    print("✅ Бот запущен")
    bot.polling(none_stop=True, interval=1, timeout=20)
